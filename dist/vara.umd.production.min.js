!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).vara={})}(this,(function(t){"use strict";function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function i(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var r=["block","line","letter","letterPart"],s=function(){function t(t){var e;this.ctx=t.ctx,this.parent=null!==(e=t.parent)&&void 0!==e?e:null,this.name="block"}return t.prototype.getParent=function(t,e){return r.indexOf(t)<r.indexOf(this.name)&&(e.name===t?e:!!e.parent&&this.getParent(t,null==e?void 0:e.parent))},t}(),h=function(t){function e(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.path=e.path,n.pathLength=e.pathLength,n.dashOffset=e.dashOffset,n.width=e.width,n.name="letterPart",n.rootBlock=n.getParent("block",i(n)),n}n(e,t);var r=e.prototype;return r.paint=function(){this.ctx.save(),this.ctx.stroke(new Path2D(this.processPath(this.path,this.x,this.y))),this.ctx.restore()},r.draw=function(t){var e=this.pathLength/(this.pathLength/this.rootBlock.totalPathLength*this.rootBlock.options.duration/1e3);this.ctx.save(),this.ctx.lineDashOffset=1,this.ctx.setLineDash([this.dashOffset,this.pathLength+1]),this.dashOffset+=e*t,this.paint(),this.ctx.restore()},r.processPath=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0);var i=t.split("");return i[2]=e+"",i[4]=n+"",i.join("")},e}(s),o=function(t){function r(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.width=e.width,n.parts=[],n.drawnParts=[],n.name="letter",n.character=e.character,n.rootBlock=n.getParent("block",i(n)),n}n(r,t);var s=r.prototype;return s.setPosition=function(t,e){this.x=t,this.y=e},s.addPart=function(t){this.parts.push(new h(e({},t,{ctx:this.ctx,parent:this}))),this.rootBlock&&this.rootBlock.modifyPathLength(t.pathLength,"increment")},s.isDone=function(){return 0===this.parts.length},s.dequeue=function(){var t=this.parts.shift();t&&this.drawnParts.push(t)},s.render=function(t,e){this.ctx.save(),this.ctx.scale(this.rootBlock.scale,this.rootBlock.scale),this.ctx.translate(this.x,this.y);var n=(t-e)/1e3;if(this.parts.length>0){var i=this.parts[0];i.dashOffset>i.pathLength?this.dequeue():i.draw(n)}this.drawnParts.forEach((function(t){t.paint()})),this.ctx.restore()},s.paint=function(){this.ctx.save(),this.ctx.scale(this.rootBlock.scale,this.rootBlock.scale),this.ctx.translate(this.x,this.y),this.drawnParts.forEach((function(t){t.paint()})),this.ctx.restore()},r}(s),a=function(t){function i(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.ctx=e.ctx,n.letters=[],n._letters=[],n.drawnLetters=[],n.name="line",n}n(i,t);var r=i.prototype;return r.addLetter=function(t){var n,i=new o(e({},t,{parent:null!==(n=t.parent)&&void 0!==n?n:this,ctx:this.ctx}));return t.character.getFontItem().paths.forEach((function(t){i.addPart({path:t.d,x:t.mx-t.dx,y:-t.my,pathLength:t.pl,dashOffset:0,width:t.w})})),this.letters.push(i),this._letters.push(i),i},r.setLetters=function(t){this._letters=t,this.letters=t.filter((function(t){return!t.isDone()})),this.drawnLetters=t.filter((function(t){return t.isDone()}))},r.generateLetter=function(t){return new o(e({},t,{parent:this,ctx:this.ctx}))},r.setPosition=function(t,e){this.x=t,this.y=e},r.isDone=function(){return 0===this.letters.length},r.getAllLetters=function(){return this._letters},r.dequeue=function(){var t=this.letters.shift();t&&this.drawnLetters.push(t)},r.render=function(t,e){if(this.ctx.save(),this.ctx.translate(this.x,this.y),this.letters.length>0){var n=this.letters[0];n.render(t,e),0===n.parts.length&&this.dequeue()}this.drawnLetters.forEach((function(t){t.paint()})),this.ctx.restore()},i}(s),c=function(t){function i(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.width=e.width,n.lines=[],n._lines=[],n.drawnLines=[],n.ctx=e.ctx,n.previousRAFTime=0,n.totalPathLength=0,n.options=e.options,n.name="block",n.scale=e.options.fontSize/16,n}n(i,t);var r=i.prototype;return r.addLine=function(t){var n=new a(e({},t,{ctx:this.ctx,parent:this}));return this.lines.push(n),this._lines.push(n),n},r.getAllLetters=function(){return this._lines.map((function(t){return t._letters})).flat()},r.getLetterById=function(t){var e;return null!==(e=this.getAllLetters().find((function(e){return e.character.id===t})))&&void 0!==e&&e},r.dequeue=function(){var t=this.lines.shift();t&&this.lines.push(t)},r.modifyPathLength=function(t,e){return void 0===e&&(e="increment"),"increment"===e?this.totalPathLength+=t:this.totalPathLength-=t,this.totalPathLength},r.render=function(t){var e=this;if(0===this.previousRAFTime&&(this.previousRAFTime=t),this.ctx.save(),this.ctx.strokeStyle=this.options.color,this.ctx.lineWidth=this.options.strokeWidth,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.drawnLines.forEach((function(n){n.render(t,e.previousRAFTime)})),this.lines.length>0){var n=this.lines[0];n.render(t,this.previousRAFTime),0===n.letters.length&&this.dequeue()}this.ctx.restore(),this.previousRAFTime=t},i}(s),u=0,l=function(){function t(t){var e;this.char=t.char,this.fontItem=t.fontItem,this.isSpace=null!==(e=t.isSpace)&&void 0!==e&&e,this.id=u,u++}var e=t.prototype;return e.getFontItem=function(){return this.fontItem},e.getId=function(){return this.id},t}(),d=function(){function t(t){var n=this;this.textItem=e({},t.options,t.textItem),this.height=0,this.fontCharacters=t.fontCharacters,this.ctx=t.ctx,this.block=null,this.text="string"==typeof this.textItem.text?[this.textItem.text.split("").map((function(t){return new l({char:t,fontItem:n.fontCharacters[t.charCodeAt(0)]||n.fontCharacters[63],isSpace:" "===t})}))]:Array.isArray(this.textItem.text)?this.textItem.text.map((function(t){return t.split("").map((function(t){return new l({char:t,fontItem:n.fontCharacters[t.charCodeAt(0)]||n.fontCharacters[63],isSpace:" "===t})}))})):[]}var n=t.prototype;return n.addLetter=function(t){var e=this,n=t.letter,i=t.position;if("number"==typeof i){var r=0;this.text.forEach((function(t,s){console.log(t,i),i<=r+t.length?(console.log("Here"),console.log("Before",JSON.parse(JSON.stringify(e.text[s]))),e.text[s]=[].concat(t.slice(0,i-r),[new l({char:n,fontItem:e.fontCharacters[n.charCodeAt(0)]||e.fontCharacters[63],isSpace:" "===n})],t.slice(i-r)),console.log("After",JSON.parse(JSON.stringify(e.text[s])))):r+=t.length}))}this.regeneratePositions()},n.regeneratePositions=function(){var t=this;console.log(this.block);var e=this.textItem.fontSize/16;this.height=0;var n=this.generateLineData(this.text),i=this.textItem.lineHeight,r=this.block;if(n.length>r._lines.length)for(;n.length>r._lines.length;)r.addLine({x:0,y:0});n.forEach((function(n,s){var h=0,o=0;"center"===t.textItem.textAlign&&(o=(t.textItem.width-n.width)/2);var a=r.lines[s];a.setPosition(o,i);var c=[];n.text.forEach((function(t){if(t.isSpace)h+=10;else{var e=r.getLetterById(t.id);e?(e.parent=a,e.setPosition(h,i),c.push(e),h+=e.character.getFontItem().w):(c.push(a.addLetter({character:t,width:t.getFontItem().w,x:h,y:i})),h+=t.getFontItem().w)}})),i+=t.textItem.lineHeight,t.height+=t.textItem.lineHeight*e,a.setLetters(c),console.log(c)}))},n.generatePositions=function(){var t=this,e=this.textItem.fontSize/16;this.height=0;var n=this.generateLineData(this.text),i=this.textItem.lineHeight,r=new c({width:this.textItem.width,x:this.textItem.x,y:this.textItem.y,ctx:this.ctx,options:this.textItem});n.forEach((function(n){var s=0,h=0;"center"===t.textItem.textAlign&&(h=(t.textItem.width-n.width)/2);var o=r.addLine({x:h,y:i});n.text.forEach((function(t){if(t.isSpace)s+=10;else{var e=t.getFontItem();o.addLetter({x:s,y:i,width:e.w,character:t}),s+=e.w}})),i+=t.textItem.lineHeight,t.height+=t.textItem.lineHeight*e})),this.block=r},n.generateLineData=function(t){var e=this,n=this.textItem.fontSize/16,i=[{text:[],width:0}],r=[];return t.forEach((function(t){var e=[[]];t.forEach((function(t){t.isSpace?e.push([]):e[e.length-1].push(t)})),r.push(e)})),r.forEach((function(r){var s=0;r.forEach((function(r){var h,o,a=0;r.forEach((function(t){var e=t.getFontItem(),i=e.paths.reduce((function(t,e){return t+e.mx-e.dx}),0);a+=(e.w+i)*n})),(null!==(h=null===(o=i[t.length-1])||void 0===o?void 0:o.width)&&void 0!==h?h:0)+a+5*n+s+e.textItem.x*n>e.textItem.width?(i.push({text:[].concat(r,[new l({char:" ",fontItem:e.fontCharacters[63],isSpace:!0})]),width:a}),s=0):(i[i.length-1]={text:[].concat(i[i.length-1].text,r,[new l({char:" ",fontItem:e.fontCharacters[63],isSpace:!0})]),width:i[i.length-1].width+a},s+=10*n)}))})),i},n.render=function(t){this.block&&this.block.render(t)},n.rendered=function(){var t;return 0===(null===(t=this.block)||void 0===t?void 0:t.lines.length)},t}(),f=function(){function t(t,e,n,i){this.elementName=t,this.element=document.querySelector(t),this.fontSource=e,this.options=i,this.textItems=n,this.renderData={nonQueued:[],queued:[]},this.rendered=!1,this.fontCharacters={},this.canvasWidth=0,this.defaultOptions={fontSize:21,strokeWidth:.5,color:"#000",duration:1e3,textAlign:"left",autoAnimation:!0,queued:!0,delay:0,breakWord:!1,letterSpacing:{global:0},width:this.element.getBoundingClientRect().width,lineHeight:30},this.defaultCharacters={63:{paths:[{w:8.6437,h:14.23173,my:22.6665,mx:0,dx:0,d:"m 0,0 c -2,-6.01,5,-8.64,8,-3.98,2,4.09,-7,8.57,-7,11.85",pl:1},{w:1.1037,h:1.5498,my:8.8815,dx:0,mx:1,d:"m 0,0 a 0.7592,0.7357,0,0,1,0,0.735,0.7592,0.7357,0,0,1,-1,-0.735,0.7592,0.7357,0,0,1,1,-0.738,0.7592,0.7357,0,0,1,0,0.738 z",pl:1}],w:8.6437}},this.canvas=document.createElement("canvas"),this.canvas.width=this.element.getBoundingClientRect().width,this.canvas.height=800,this.ctx=this.canvas.getContext("2d"),this.element.appendChild(this.canvas),this.WHITESPACE=10,this.SCALEBASE=16,this.contextHeight=0,this.init()}var n=t.prototype;return n.init=function(){var t=this;this.normalizeOptions();var e=new XMLHttpRequest;e.open("GET",this.fontSource,!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var n=JSON.parse(e.responseText);t.fontCharacters=n.c,t.fontProperties=n.p,t.preRender(),t.render()}},e.send(null)},n.onDraw=function(t){this.onDrawF=t},n.normalizeOptions=function(){var t=this;this.options=this.options||{},this.options=e({},this.defaultOptions,this.options),Object.keys(this.defaultCharacters).forEach((function(e){void 0===t.fontCharacters[e]&&(t.fontCharacters[e]=t.defaultCharacters[e])}))},n.preRender=function(){var t=this,e=this.createSVGNode("svg",{width:"100",height:"100"});e.style.position="absolute",e.style.zIndex="-100",e.style.opacity="0",e.style.top="0",document.body.appendChild(e);var n=this.createSVGNode("path",{d:""});e.appendChild(n),this.objectKeys(this.fontCharacters).forEach((function(e){t.fontCharacters[e].paths.forEach((function(i,r){n.setAttributeNS(null,"d",i.d),t.fontCharacters[e].paths[r].dx=n.getBoundingClientRect().x,t.fontCharacters[e].paths[r].pl=n.getTotalLength()}))})),this.textItems.forEach((function(e){var n=new d({fontCharacters:t.fontCharacters,options:t.options,textItem:e,ctx:t.ctx});n.generatePositions(),e.queued?t.renderData.queued.push(n):t.renderData.nonQueued.push(n)}))},n.render=function(t){var e=this;void 0===t&&(t=0);var n=this.calculateCanvasHeight();if(n!==this.canvas.height&&(this.canvas.height=n),this.ctx.clearRect(0,0,this.canvas.width,n),this.renderData.nonQueued.forEach((function(e){e.render(t)})),this.renderData.queued.length>0){var i=this.renderData.queued[0];i.render(t),i.rendered()&&this.dequeue()}window.requestAnimationFrame((function(t){return e.render(t)}))},n.dequeue=function(){var t=this.renderData.queued.shift();t&&this.renderData.nonQueued.push(t)},n.calculateCanvasHeight=function(){var t=0;return[].concat(this.renderData.nonQueued,this.renderData.queued).forEach((function(e){e.height&&e.textItem.y&&(t+=e.height+e.textItem.y)})),t+50},n.addLetter=function(t){var e=t.letter,n=t.id,i=t.position,r=[].concat(this.renderData.nonQueued,this.renderData.queued).find((function(t){return t.textItem.id===n}));console.log(e,i),null==r||r.addLetter({letter:e,position:i})},n.createSVGNode=function(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg",t);for(var i in e)n.setAttributeNS(null,i.replace(/[A-Z]/g,(function(t){return"-"+t.toLowerCase()})),e[i]);return n},n.processPath=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0);var i=t.split("");return i[2]=e+1+"",i[4]=n+"",i.join("")},n.objectKeys=function(t){return Object.keys(t)},n.boundRect=function(t,e,n,i){void 0===i&&(i=10),this.ctx.save(),this.ctx.fillStyle="rgba(209, 56, 61,0.4)",this.ctx.fillRect(t,e,n,i),this.ctx.fill(),this.ctx.restore()},t}();window&&(window.Vara=f),t.default=f,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=vara.umd.production.min.js.map
