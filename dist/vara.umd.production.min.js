!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Vara={})}(this,(function(t){"use strict";function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function i(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var r=0,s=function(){function t(t){var e;this.char=t.char,this.fontItem=t.fontItem,this.isSpace=null!=(e=t.isSpace)&&e,this.id=r,r++}var e=t.prototype;return e.getFontItem=function(){return this.fontItem},e.getId=function(){return this.id},t}(),o=["block","line","letter","letterPart"],h=function(){function t(t){var e;this.ctx=t.ctx,this.parent=null!=(e=t.parent)?e:null,this.name="block"}return t.prototype.getParent=function(t,e){return o.indexOf(t)<o.indexOf(this.name)&&(e.name===t?e:!!e.parent&&this.getParent(t,null==e?void 0:e.parent))},t}(),a=function(t){function e(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.path=e.path,n.pathLength=e.pathLength,n.dashOffset=e.dashOffset,n.width=e.width,n.name="letterPart",n.rootBlock=n.getParent("block",i(n)),n}n(e,t);var r=e.prototype;return r.paint=function(){this.ctx.save(),this.ctx.stroke(new Path2D(this.processPath(this.path,this.x,this.y))),this.ctx.restore()},r.draw=function(t){var e=this.pathLength/(this.pathLength/this.rootBlock.totalPathLength*this.rootBlock.options.duration/1e3);this.ctx.save(),this.ctx.lineDashOffset=1,this.ctx.setLineDash([this.dashOffset,this.pathLength+1]),this.dashOffset+=e*t,this.paint(),this.ctx.restore()},r.processPath=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0);var i=t.split("");return i[2]=e+"",i[4]=n+"",i.join("")},e}(h),c=0,u=function(t){function r(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.width=e.width,n.parts=[],n.drawnParts=[],n.name="letter",n.character=e.character,n.id=c,c++,n.rootBlock=n.getParent("block",i(n)),n}n(r,t);var s=r.prototype;return s.setPosition=function(t,e){this.x=t,this.y=e},s.addPart=function(t){this.parts.push(new a(e({},t,{ctx:this.ctx,parent:this}))),this.rootBlock&&this.rootBlock.modifyPathLength(t.pathLength,"increment")},s.setParent=function(t){this.parent=t},s.isDone=function(){return 0===this.parts.length},s.dequeue=function(){var t=this.parts.shift();t&&this.drawnParts.push(t)},s.render=function(t,e){this.ctx.save(),this.ctx.scale(this.rootBlock.scale,this.rootBlock.scale),this.ctx.translate(this.x,this.y);var n=(t-e)/1e3;if(this.parts.length>0){var i=this.parts[0];i.dashOffset>i.pathLength?this.dequeue():i.draw(n)}this.drawnParts.forEach((function(t){t.paint()})),this.ctx.restore()},s.paint=function(){this.ctx.save(),this.ctx.scale(this.rootBlock.scale,this.rootBlock.scale),this.ctx.translate(this.x,this.y),this.drawnParts.forEach((function(t){t.paint()})),this.ctx.restore()},r}(h),f=0,l=function(t){function i(e){var n;return(n=t.call(this,e)||this).x=e.x,n.y=e.y,n.ctx=e.ctx,n.letters=[],n.drawnLetters=[],n.name="line",n.id=f,f++,n}n(i,t);var r=i.prototype;return r.addLetter=function(t){var n,i=new u(e({},t,{parent:null!=(n=t.parent)?n:this,ctx:this.ctx}));return t.character.getFontItem().paths.forEach((function(t){i.addPart({path:t.d,x:t.mx-t.dx,y:-t.my,pathLength:t.pl,dashOffset:0,width:t.w})})),this.letters.push(i),i},r.removeLetter=function(t){this.letters=this.letters.filter((function(e){return e.id!==t})),this.drawnLetters=this.drawnLetters.filter((function(e){return e.id!==t}))},r.setLetters=function(t){this.letters=t.filter((function(t){return!t.isDone()})),this.drawnLetters=t.filter((function(t){return t.isDone()}))},r.setPosition=function(t,e){this.x=t,this.y=e},r.isDone=function(){return 0===this.letters.length},r.getAllLetters=function(){return[].concat(this.letters,this.drawnLetters)},r.dequeue=function(){var t=this.letters.shift();t&&this.drawnLetters.push(t)},r.render=function(t,e){if(this.ctx.save(),this.ctx.translate(this.x,this.y),this.letters.length>0){var n=this.letters[0];n.render(t,e),n.isDone()&&this.dequeue()}this.drawnLetters.forEach((function(t){t.paint()})),this.ctx.restore()},i}(h),d=function(t){function i(e){var n;return(n=t.call(this,e)||this).x=e.options.x,n.y=e.options.y,n.width=e.options.width,n.height=0,n.lines=[],n.drawnLines=[],n.ctx=e.ctx,n.previousRAFTime=0,n.totalPathLength=0,n.text=[],n.options=e.options,n.name="block",n.root=e.root,n.scale=e.options.fontSize/n.root.SCALEBASE,n.userDefinedRenderFn=function(){return null},n.initTextToVaraChar(),n.generatePositions(),n}n(i,t);var r=i.prototype;return r.initTextToVaraChar=function(){var t=this;this.text="string"==typeof this.options.text?[this.options.text.split("").map((function(e){return new s({char:e,fontItem:t.root.fontCharacters[e.charCodeAt(0)]||t.root.fontCharacters[63],isSpace:" "===e})}))]:Array.isArray(this.options.text)?this.options.text.map((function(e){return e.split("").map((function(e){return new s({char:e,fontItem:t.root.fontCharacters[e.charCodeAt(0)]||t.root.fontCharacters[63],isSpace:" "===e})}))})):[]},r.regeneratePositions=function(t){var e=this,n=this.scale;this.height=0;var i=this.options.lineHeight,r=[];t.forEach((function(t,s){var o=0,h=0,a=i*e.scale;"center"===e.options.textAlign&&(h=(e.options.width-t.width)/2);var c=e.getLineAtIndex(s);c.setPosition(h,a);var u=[];t.text.forEach((function(t){if(t.isSpace)o+=e.root.WHITESPACE;else{var n=e.getLetterByCharacterId(t.id);n?(n.setParent(c),n.setPosition(o,0),u.push(n),o+=n.character.getFontItem().w):console.error("Error - Letter with id "+t.id+" not found")}})),i+=e.options.lineHeight,e.height+=e.options.lineHeight*n,r.push(u)})),this.getLines().forEach((function(t,e){t.setLetters(r[e])}))},r.generatePositions=function(){var t=this,e=this.scale;this.height=0;var n=this.generateLineData(this.text),i=this.options.lineHeight;n.forEach((function(n){var r=0,s=0;"center"===t.options.textAlign&&(s=(t.options.width-n.width)/2);var o=t.addLine({x:s,y:i});n.text.forEach((function(e){if(e.isSpace)r+=t.root.WHITESPACE;else{var n=e.getFontItem();o.addLetter({x:r,y:0,width:n.w,character:e}),r+=n.w}})),i+=t.options.lineHeight,t.height+=t.options.lineHeight*e}))},r.generateLineData=function(t){var e=this,n=this.options.fontSize/this.root.SCALEBASE,i=[{text:[],width:0}],r=[];return t.forEach((function(t){var e=[[]];t.forEach((function(t){t.isSpace?e.push([]):e[e.length-1].push(t)})),r.push(e)})),r.forEach((function(t){var r=0;t.forEach((function(t){var o,h,a=0;t.forEach((function(t){var e=t.getFontItem(),i=e.paths.reduce((function(t,e){return t+e.mx-e.dx}),0);a+=(e.w+i)*n}));var c=new s({char:" ",fontItem:e.root.fontCharacters[32],isSpace:!0});(null!=(o=null==(h=i[i.length-1])?void 0:h.width)?o:0)+a+r+e.options.x>e.options.width?(i.push({text:[].concat(t,[c]),width:a}),r=0):(i[i.length-1]={text:[].concat(i[i.length-1].text,t,[c]),width:i[i.length-1].width+a},r+=e.root.WHITESPACE*n)}))})),i},r.addLine=function(t){var n=new l(e({},t,{ctx:this.ctx,parent:this}));return this.lines.push(n),n},r.removeLine=function(t){var e=this.getLines();if(t){var n=e[t];n&&(this.lines=this.lines.filter((function(t){return t.id!==n.id})),this.drawnLines=this.drawnLines.filter((function(t){return t.id!==n.id})))}else{var i=e[e.length-1];this.lines=this.lines.filter((function(t){return t.id!==i.id})),this.drawnLines=this.drawnLines.filter((function(t){return t.id!==i.id}))}},r.getCursorPosition=function(t){var e=this,n=0,i=-1;if(this.text.forEach((function(r,s){s<n+r.length?i=e.text[s][t-n].id:n+=r.length})),i>-1){var r=this.getLetterByCharacterId(i);if(r){var s=r.getParent("line",r);return{x:s.x+(r.x+r.width)*this.scale,y:s.y}}return console.warn("Letter not found"),!1}return console.warn("Character Not found"),!1},r.addLetter=function(t){var e=this,n=t.letter,i=t.position,r=new s({char:n,fontItem:this.root.fontCharacters[n.charCodeAt(0)]||this.root.fontCharacters[63],isSpace:" "===n});if(console.log(n),"number"==typeof i){var o=0;this.text.forEach((function(t,n){i<=o+t.length?e.text[n]=[].concat(t.slice(0,i-o),[r],t.slice(i-o)):o+=t.length}))}var h=this.generateLineData(this.text);if(h.length>this.getLineCount())for(;h.length>this.getLineCount();)this.addLine({x:0,y:0});this.getLastLine().addLetter({character:r,width:r.fontItem.w,x:0,y:0}),this.regeneratePositions(h)},r.removeLetter=function(t){var e=this,n=t.position,i=-1;if("number"==typeof n){var r=0;this.text.forEach((function(t,s){n<=r+t.length&&n<=r+t.length?(i=e.text[s][n-r].id,e.text[s].splice(n-r,1)):r+=t.length}))}var s=this.generateLineData(this.text);if(s.length<this.getLineCount())for(;s.length<this.getLineCount();)this.removeLine();var o=this.getAllLetters().find((function(t){return t.character.getId()===i}));if(o){var h=o.getParent("line",o);h&&h.removeLetter(o.id)}this.regeneratePositions(s)},r.getAllLetters=function(){return this.getLines().map((function(t){return t.getAllLetters()})).flat()},r.getLines=function(){return[].concat(this.lines,this.drawnLines)},r.getLineCount=function(){return this.getLines().length},r.getLineAtIndex=function(t){return this.getLines()[t]},r.getLastLine=function(){var t=this.getLines();return t[t.length-1]},r.getLetterByCharacterId=function(t){var e;return null!=(e=this.getAllLetters().find((function(e){return e.character.id===t})))&&e},r.setRenderFunction=function(t){this.userDefinedRenderFn=t},r.dequeue=function(){var t=this.lines.shift();t&&this.drawnLines.push(t)},r.modifyPathLength=function(t,e){return void 0===e&&(e="increment"),"increment"===e?this.totalPathLength+=t:this.totalPathLength-=t,this.totalPathLength},r.render=function(t){var e=this;if(0===this.previousRAFTime&&(this.previousRAFTime=t),this.ctx.save(),this.ctx.translate(this.x,this.y),this.ctx.strokeStyle=this.options.color,this.ctx.lineWidth=this.options.strokeWidth,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.drawnLines.forEach((function(n){n.render(t,e.previousRAFTime)})),this.lines.length>0){var n=this.lines[0];n.isDone()&&this.dequeue(),n.render(t,this.previousRAFTime)}this.userDefinedRenderFn(this.ctx,t),this.ctx.restore(),this.previousRAFTime=t},i}(h),p=function(){function t(t,e,n,i){this.elementName=t,this.element=document.querySelector(t),this.fontSource=e,this.options=i,this.textItems=n,this.blocks=[],this.rendered=!1,this.fontCharacters={},this.canvasWidth=0,this.defaultOptions={fontSize:21,strokeWidth:.5,color:"#000",duration:1e3,textAlign:"left",autoAnimation:!0,queued:!0,delay:0,breakWord:!1,letterSpacing:{global:0},width:this.element.getBoundingClientRect().width,lineHeight:30},this.defaultCharacters={63:{paths:[{w:8.6437,h:14.23173,my:22.6665,mx:0,dx:0,d:"m 0,0 c -2,-6.01,5,-8.64,8,-3.98,2,4.09,-7,8.57,-7,11.85",pl:1},{w:1.1037,h:1.5498,my:8.8815,dx:0,mx:1,d:"m 0,0 a 0.7592,0.7357,0,0,1,0,0.735,0.7592,0.7357,0,0,1,-1,-0.735,0.7592,0.7357,0,0,1,1,-0.738,0.7592,0.7357,0,0,1,0,0.738 z",pl:1}],w:8.6437}},this.canvas=document.createElement("canvas"),this.canvas.width=this.element.getBoundingClientRect().width,this.canvas.height=800,this.ctx=this.canvas.getContext("2d"),this.element.appendChild(this.canvas),this.WHITESPACE=10,this.SCALEBASE=16,this.contextHeight=0,this.init()}var n=t.prototype;return n.init=function(){var t=this;this.normalizeOptions();var e=new XMLHttpRequest;e.open("GET",this.fontSource,!0),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var n=JSON.parse(e.responseText);t.fontCharacters=n.c,t.fontProperties=n.p,void 0===t.fontCharacters[32]&&t.createWhitespaceLine(),t.preRender(),t.readyfn&&t.readyfn(),t.render()}},e.send(null)},n.ready=function(t){this.readyfn=t},n.onDraw=function(t){this.onDrawF=t},n.normalizeOptions=function(){var t=this;this.options=this.options||{},this.options=e({},this.defaultOptions,this.options),Object.keys(this.defaultCharacters).forEach((function(e){void 0===t.fontCharacters[e]&&(t.fontCharacters[e]=t.defaultCharacters[e])}))},n.preRender=function(){var t=this,n=this.createSVGNode("svg",{width:"100",height:"100"});n.style.position="absolute",n.style.zIndex="-100",n.style.opacity="0",n.style.top="0",document.body.appendChild(n);var i=this.createSVGNode("path",{d:""});n.appendChild(i),this.objectKeys(this.fontCharacters).forEach((function(e){t.fontCharacters[e].paths.forEach((function(n,r){i.setAttributeNS(null,"d",n.d),t.fontCharacters[e].paths[r].dx=i.getBoundingClientRect().x,t.fontCharacters[e].paths[r].pl=i.getTotalLength()}))})),this.textItems.forEach((function(n){var i=new d({root:t,options:e({},t.options,n),ctx:t.ctx});t.blocks.push(i)}))},n.createWhitespaceLine=function(){this.fontCharacters[32]={paths:[{d:"m0,0 l0,0 "+this.WHITESPACE+",0",dx:0,h:1,mx:0,my:0,pl:this.WHITESPACE,w:this.WHITESPACE}],w:this.WHITESPACE}},n.render=function(t){var e=this;void 0===t&&(t=0);var n=this.calculateCanvasHeight();n!==this.canvas.height&&(this.canvas.height=n),this.ctx.clearRect(0,0,this.canvas.width,n),this.blocks.forEach((function(e){e.render(t)})),window.requestAnimationFrame((function(t){return e.render(t)}))},n.calculateCanvasHeight=function(){var t=0;return this.blocks.forEach((function(e){e.height&&e.options.y&&(t+=e.height+e.options.y)})),t+50},n.addLetter=function(t){var e=t.letter,n=t.id,i=t.position,r=this.blocks.find((function(t){return t.options.id===n}));console.log(e),null==r||r.addLetter({letter:e,position:i})},n.removeLetter=function(t){var e=t.id,n=t.position,i=this.blocks.find((function(t){return t.options.id===e}));null==i||i.removeLetter({position:n})},n.getCursorPosition=function(t){var e=t.position,n=t.id,i=this.blocks.find((function(t){return t.options.id===n}));return null==i?void 0:i.getCursorPosition(e)},n.setRenderFunction=function(t,e){var n=this.blocks.find((function(e){return e.options.id===t}));return null==n?void 0:n.setRenderFunction(e)},n.createSVGNode=function(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg",t);for(var i in e)n.setAttributeNS(null,i.replace(/[A-Z]/g,(function(t){return"-"+t.toLowerCase()})),e[i]);return n},n.processPath=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0);var i=t.split("");return i[2]=e+1+"",i[4]=n+"",i.join("")},n.objectKeys=function(t){return Object.keys(t)},n.boundRect=function(t,e,n,i){void 0===i&&(i=10),this.ctx.save(),this.ctx.fillStyle="rgba(209, 56, 61,0.4)",this.ctx.fillRect(t,e,n,i),this.ctx.fill(),this.ctx.restore()},t}();window&&(window.Vara=p),t.default=p,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=vara.umd.production.min.js.map
